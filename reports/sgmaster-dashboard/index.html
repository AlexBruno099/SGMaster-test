<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>SGMaster Test Center â€” Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; background: #F5F7FB; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.08); padding: 1.5rem; transition: 0.3s; }
    .card:hover { transform: scale(1.02); }
    .status-success { background: #28C76F; color: white; padding: 0.2rem 0.7rem; border-radius: 5px; }
    .status-fail { background: #EA5455; color: white; padding: 0.2rem 0.7rem; border-radius: 5px; }
    .ia-box { background: #EAF3FF; border-left: 4px solid #004AAD; padding: 0.8rem; border-radius: 8px; margin-top: 10px; }
    img { border-radius: 10px; margin-top: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-700 to-blue-500 text-white p-6 shadow-md">
    <h1 class="text-3xl font-semibold">ğŸ§­ SGMaster Test Center Dashboard</h1>
    <p class="opacity-80 text-sm mt-1">Monitoramento em tempo real de execuÃ§Ãµes automatizadas</p>
  </header>

  <!-- Main -->
  <main class="flex flex-1 gap-6 p-6">
    <!-- Sidebar -->
    <aside class="w-72 bg-white p-4 rounded-xl shadow-md">
      <h2 class="text-lg font-semibold mb-3">ğŸ“‹ Testes Registrados</h2>
      <div id="testList" class="space-y-2 text-sm"></div>
    </aside>

    <!-- Dashboard -->
    <section class="flex-1 flex flex-col gap-6">
      <!-- Cards -->
      <div class="grid grid-cols-3 gap-6">
        <div class="card text-center">
          <h3 class="font-semibold text-gray-600">Sucessos</h3>
          <p id="successCount" class="text-3xl font-bold text-green-500">0</p>
        </div>
        <div class="card text-center">
          <h3 class="font-semibold text-gray-600">Falhas</h3>
          <p id="failCount" class="text-3xl font-bold text-red-500">0</p>
        </div>
        <div class="card text-center">
          <h3 class="font-semibold text-gray-600">Tempo mÃ©dio</h3>
          <p id="avgTime" class="text-3xl font-bold text-blue-500">0s</p>
        </div>
      </div>

      <!-- GrÃ¡ficos -->
      <div class="grid grid-cols-2 gap-6">
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">ğŸ“Š Status dos Testes</h3>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-2">ğŸ“… HistÃ³rico por ExecuÃ§Ã£o</h3>
          <canvas id="timeChart"></canvas>
        </div>
      </div>

      <!-- Detalhes -->
      <div id="details" class="card">
        <h3 class="text-lg font-semibold">Detalhes do Teste</h3>
        <p class="text-gray-500">Selecione um teste na barra lateral.</p>
      </div>
    </section>
  </main>

  <footer class="text-center text-sm py-3 text-gray-500">
    Â© 2025 SGMaster QA | â€œDeus seja louvadoâ€
  </footer>

  <script>
    // Armazena dados globais
    window.reportData = [];

    let statusChart, timeChart;

    async function carregarDados() {
      try {
        const res = await fetch('../../data/results.json?' + Date.now());
        if (!res.ok) throw new Error("NÃ£o foi possÃ­vel acessar results.json");
        const data = await res.json();
        window.reportData = data;

        console.log("ğŸ“„ Dados carregados:", data);

        // CÃ¡lculos
        const success = data.filter(d => d.status === "SUCESSO").length;
        const fail = data.filter(d => d.status === "FALHA").length;
        const avg = (data.reduce((a, b) => a + (b.duracao || 0), 0) / (data.length || 1)).toFixed(2);

        // Atualiza cards
        document.getElementById('successCount').textContent = success;
        document.getElementById('failCount').textContent = fail;
        document.getElementById('avgTime').textContent = avg + "s";

        // === Sidebar ===
        const testList = document.getElementById('testList');
        testList.innerHTML = data.map(t => `
          <div class="p-2 border rounded cursor-pointer hover:bg-gray-100 flex justify-between items-center"
               onclick="mostrarDetalhes('${t.id}')">
            <span>${t.icone || 'ğŸ§ª'} ${t.nome}</span>
            <span class="${t.status === 'SUCESSO' ? 'status-success' : 'status-fail'}">${t.status}</span>
          </div>
        `).join('');

        // === Atualiza grÃ¡fico de status ===
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(document.getElementById('statusChart'), {
          type: 'doughnut',
          data: {
            labels: ['Sucesso', 'Falha'],
            datasets: [{
              data: [success, fail],
              backgroundColor: ['#28C76F', '#EA5455']
            }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });

        // === Atualiza grÃ¡fico de tempo ===
        if (timeChart) timeChart.destroy();
        timeChart = new Chart(document.getElementById('timeChart'), {
          type: 'line',
          data: {
            labels: data.map(t => t.data_execucao),
            datasets: [{
              label: 'Tempo (s)',
              data: data.map(t => t.duracao),
              borderColor: '#007BFF',
              tension: 0.3,
              fill: false
            }]
          }
        });

      } catch (err) {
        console.error("âŒ Erro ao carregar dados:", err);
        document.getElementById('details').innerHTML = `
          <div class="ia-box text-red-500">Erro ao carregar o arquivo de resultados. 
          Verifique se o caminho <b>Reports/sgmaster-dashboard/data/results.json</b> existe e contÃ©m dados vÃ¡lidos.</div>
        `;
      }
    }

    function mostrarDetalhes(id) {
      console.log("ğŸ” Procurando teste:", id);
      const t = window.reportData.find(x => x.id === id);
      if (!t) {
        document.getElementById('details').innerHTML = `
          <h3 class="text-lg font-semibold text-red-600">Erro</h3>
          <p>NÃ£o foi possÃ­vel encontrar o teste com ID <b>${id}</b>.</p>
        `;
        return;
      }

      const iaDescricao = gerarDescricaoIA(t);

      document.getElementById('details').innerHTML = `
        <h3 class="text-xl font-semibold mb-2">${t.icone || 'ğŸ§ª'} ${t.nome}</h3>
        <span class="${t.status === 'SUCESSO' ? 'status-success' : 'status-fail'}">${t.status}</span>
        <p class="mt-2"><b>Executado em:</b> ${t.data_execucao}</p>
        <p><b>DuraÃ§Ã£o:</b> ${t.duracao}s</p>
        ${t.erro ? `<p class="text-red-500 mt-2"><b>Erro:</b> ${t.erro}</p>` : ""}
        <h4 class="font-semibold mt-4">Etapas:</h4>
        <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">${t.etapas?.join('\n') || "Sem etapas registradas"}</pre>
        ${t.screenshot ? `<img src="../${t.screenshot}" class="mt-3 w-1/2">` : ""}
        <div class="ia-box mt-4">
          <b>ğŸ¤– AnÃ¡lise Inteligente:</b>
          <p class="text-sm mt-1">${iaDescricao}</p>
        </div>
      `;
    }

    function gerarDescricaoIA(t) {
      if (t.status === "SUCESSO")
        return `O teste "${t.nome}" executou com sucesso em ${t.duracao}s, validando o fluxo principal sem falhas.`;
      else if (t.erro?.toLowerCase().includes("timeout"))
        return `O teste "${t.nome}" falhou por tempo de espera excedido. Verifique a estabilidade da pÃ¡gina ou os seletores.`;
      else
        return `O teste "${t.nome}" apresentou falhas inesperadas. Analise os logs e screenshots para diagnÃ³stico.`;
    }

    // Carrega dados e atualiza automaticamente a cada 10s
    carregarDados();
    setInterval(carregarDados, 10000);
  </script>
</body>
</html>
